<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css"
      type="text/css"
    /> -->
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
      }
      .map {
        height: 100vh;
        width: 100%;
      }
    </style>
    <!-- <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
    <script src="/proj4.js"></script> -->
    <link  href="https://tile.gbif.org/ui/ol.css" rel="stylesheet" type="text/css">
    <script src="https://tile.gbif.org/ui/ol-debug.js"></script>
    <script src="https://tile.gbif.org/ui/proj4.js"></script>
    <title>OpenLayers example</title>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script type="text/javascript">
      let occurrenceDensity_Vector_3857 = function () {
        return new ol.layer.VectorTile({
          renderMode: 'image',
          source: new ol.source.VectorTile({
            format: new ol.format.MVT(),
            projection: 'EPSG:3857',
            tileGrid: ol.tilegrid.createXYZ({
              maxZoom: 16,
              tileSize: 512,
            }),
            tilePixelRatio: 8,
            url:
              //http://localhost:4200/api/tile/point/0/0/0.mvt?resolution=medium&field=coordinates&filter=%7B%7D
              // 'http://localhost:4200/api/tile/point/{x}/{y}/{z}.mvt?resolution=medium&field=coordinates&filter=%7B%7D',
            'https://api.gbif.org/v2/map/occurrence/density/{z}/{x}/{y}.mvt?srs=EPSG:3857&',
            wrapX: false,
          }),
          style: densityStyle(),
        });
      };

      var densityColours = [
        '#FFFF00FF',
        '#FFCC00BB',
        '#FF9900AA',
        '#FF660099',
        '#FF330099',
        '#FF000099',
      ];

      var densityPoints = [
        new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({ color: densityColours[0] }),
            radius: 2,
          }),
          fill: new ol.style.Fill({ color: densityColours[0] }),
        }),
        new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({ color: densityColours[1] }),
            radius: 3,
          }),
          fill: new ol.style.Fill({ color: densityColours[1] }),
        }),
        new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({ color: densityColours[2] }),
            radius: 3,
          }),
          fill: new ol.style.Fill({ color: densityColours[2] }),
        }),
        new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({ color: densityColours[3] }),
            radius: 4,
          }),
          fill: new ol.style.Fill({ color: densityColours[3] }),
        }),
        new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({ color: densityColours[4] }),
            radius: 5,
          }),
          fill: new ol.style.Fill({ color: densityColours[4] }),
        }),
        new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({ color: densityColours[5] }),
            radius: 6,
          }),
          fill: new ol.style.Fill({ color: densityColours[5] }),
        }),
      ];

      var magnitude = function (total) {
        if (total <= 10) return 0;
        if (total <= 1000) return 1;
        if (total <= 10000) return 2;
        if (total <= 100000) return 3;
        if (total <= 1000000) return 4;
        return 5;
      };

      function densityStyle() {
        return function (feature, resolution) {
          var styles = [];
          var m = magnitude(feature.get('total'));
          var type = feature.getType();

          if (type == 'Point') {
            styles[0] = densityPoints[m];
          } else if (type == 'Polygon') {
            styles[0] = densityHexagons[m];
          }

          return styles;
        };
      }
      
      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM(),
          }),
          occurrenceDensity_Vector_3857()
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 4,
        }),
      });

    </script>
  </body>
</html>
